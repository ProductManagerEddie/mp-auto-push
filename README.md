# 微信公众号彩票信息自动推送工具

一个基于Node.js的微信公众号彩票信息自动推送工具，能够从指定的彩票服务获取最新开奖数据，通过智谱AI生成规范的公众号文章，并自动推送到微信公众号草稿箱。支持后台服务运行、定时任务调度和手动触发推送，专注于双色球、快乐8、七乐彩、福彩3D等彩票类型。

## 功能特性

- 🔄 **自动获取彩票数据**: 从指定的彩票服务获取最新开奖信息，支持双色球、快乐8、七乐彩、福彩3D
- 🤖 **AI文章生成**: 使用智谱AI将彩票数据转换为适合公众号的规范文章格式
- 📝 **统一标题格式**: 自动生成标准化标题：【彩票类型】开奖结果第【开奖期号】期中奖号码
- 📱 **微信推送**: 自动将生成的文章推送到微信公众号草稿箱
- 💾 **本地备份**: 支持将文章保存到本地文件（当微信配置缺失时）
- ⏰ **定时任务**: 支持每天自动执行推送任务
- 🔧 **后台服务**: 支持后台守护进程运行，提供服务管理功能
- 🌐 **手动触发API**: 提供RESTful API接口，支持手动触发推送任务
- 📊 **推送历史记录**: 记录所有推送任务的执行情况
- 📋 **日志记录**: 完整的日志记录系统，支持不同级别的日志输出
- 🚀 **进程管理**: 支持PM2进程管理，提供进程监控和自动重启
- ⚙️ **灵活配置**: 支持环境变量配置，易于部署和管理
- 📅 **日期匹配**: 只推送当天开奖的彩票信息
- 📚 **固定文章顺序**: 双色球、快乐8、七乐彩、福彩3D（按固定顺序排列）
- 📏 **动态文章数量**: 根据当天开奖情况生成对应数量的文章，不强行要求4篇
- 🎨 **统一排版样式**: 所有彩票类型文章使用统一的排版格式
- 🎯 **AI提示词优化**: 针对不同彩票类型生成定制化提示词，确保内容准确性

## 工作流程

1. **获取当天日期** - 确定当前日期，用于筛选当天开奖的彩票
2. **遍历彩票类型** - 按固定顺序（双色球、快乐8、七乐彩、福彩3D）处理每种彩票类型
3. **获取彩票数据** - 从指定的彩票服务获取最新的彩票信息
4. **日期匹配筛选** - 只保留当天开奖的彩票数据
5. **AI内容生成** - 将彩票数据发送给智谱AI，生成适合公众号的文章内容（带彩票类型提示）
6. **生成统一标题** - 自动生成标准化标题：【彩票类型】开奖结果第【开奖期号】期中奖号码
7. **内容解析** - 解析AI生成的文章，提取正文内容
8. **统一排版处理** - 应用统一的HTML样式，确保格式一致性
9. **推送发布** - 将文章推送到微信公众号草稿箱，或保存到本地文件
10. **记录历史** - 保存推送任务的执行结果到历史记录
11. **状态查询** - 支持通过API查询推送任务的执行状态

## 安装使用

### 环境要求

- Node.js 16.0.0 或更高版本
- npm 包管理器

### 快速开始

1. **克隆项目**
```bash
git clone <repository-url>
cd mp-auto-push
```

2. **安装依赖**
```bash
npm install
```

3. **配置环境变量**
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，填入你的配置信息
nano .env
```

4. **创建必要目录**
```bash
mkdir -p logs output images
```

### 运行方式

#### 单次执行
```bash
# 执行一次推送
npm run dev

# 查看帮助信息
npm run help

# 查看配置说明
npm run config
```

## 配置说明

### 环境变量配置

编辑 `.env` 文件：

```env
# 智谱AI配置 (必需)
ZHIPU_API_KEY=your_zhipu_api_key
ZHIPU_MODEL=glm-4-flash

# 微信公众号配置 (可选)
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret

# 彩票API配置 (可选)
LOTTERY_API_URL=http://localhost:5000
LOTTERY_API_TIMEOUT=10000
```

### 智谱AI配置

- `ZHIPU_API_KEY`: 智谱AI的API密钥（必需）
- `ZHIPU_MODEL`: 智谱AI模型名称，默认为 `glm-4-flash`（可选）

获取方式：访问 [智谱AI开放平台](https://open.bigmodel.cn/) 注册并获取API访问权限

### 微信公众号配置

需要在[微信公众平台](https://mp.weixin.qq.com/)获取：

- `WECHAT_APP_ID`: 公众号的AppID
- `WECHAT_APP_SECRET`: 公众号的AppSecret

**注意**: 
- 微信公众号需要已认证并开通相关接口权限
- 如果不配置微信公众号信息，文章将保存到本地 `output` 目录

### 彩票API配置

- `LOTTERY_API_URL`: 彩票数据API地址，默认 `http://localhost:5000`
- `LOTTERY_API_TIMEOUT`: 彩票API请求超时时间，默认 10000ms

## 彩票类型说明

### 支持的彩票类型

| 彩票类型 | 代码 | 说明 |
|---------|------|------|
| 双色球 | ssq | 中国福利彩票双色球 |
| 快乐8 | kl8 | 中国福利彩票快乐8 |
| 七乐彩 | qlc | 中国福利彩票七乐彩 |
| 福彩3D | 3d | 中国福利彩票3D |

### 文章顺序

文章按固定顺序排列：
1. 双色球
2. 快乐8
3. 七乐彩
4. 福彩3D

### 文章数量

- 根据当天开奖情况生成对应数量的文章
- 当天无开奖信息的彩票类型会被跳过
- 不强行要求生成4篇文章
- 当天所有彩票均无开奖信息时，不生成草稿文章

## 命令行选项

```bash
# 直接运行（开发模式）
npm run dev

# 直接运行（生产模式）
npm run start

# 显示帮助信息
npm run help

# 显示配置说明
npm run config

# 守护进程管理
npm run daemon              # 显示守护进程帮助
npm run daemon:start        # 启动守护进程
npm run daemon:stop         # 停止守护进程
npm run daemon:restart      # 重启守护进程
npm run daemon:status       # 查看守护进程状态
npm run daemon:run          # 直接运行守护进程

# PM2进程管理
npm run pm2:start           # 使用PM2启动服务
npm run pm2:stop            # 使用PM2停止服务
npm run pm2:restart         # 使用PM2重启服务
npm run pm2:delete          # 使用PM2删除服务
npm run pm2:logs            # 查看PM2日志
npm run pm2:status          # 查看PM2状态

# HTTP服务器管理
npm run server              # 启动HTTP服务器
npm run server:dev          # 启动HTTP服务器（开发模式）
```

## 测试功能

本项目提供了测试脚本，用于验证核心功能的正确性：

### 草稿创建功能测试

```bash
# 运行草稿创建功能测试
node test_draft_creation.js
```

测试内容包括：
- 验证文章数据验证功能
- 测试不完整的文章数据
- 测试重复的文章类型
- 测试无效的文章类型

### 日期匹配功能测试

```bash
# 运行日期匹配功能测试
node test_date_matching.js
```

测试内容包括：
- 验证日期匹配逻辑
- 测试不同日期的彩票数据筛选
- 验证文章数据生成

### 手动测试

```bash
# 手动运行推送流程测试
npm run dev
```

## 项目结构

```
mp-auto-push/
├── src/
│   ├── index.js           # 主程序入口
│   ├── lotteryService.js  # 彩票数据获取服务
│   ├── aiService.js       # AI文章生成服务
│   ├── wechatService.js   # 微信公众号服务
│   ├── logger.js          # 日志记录模块
│   ├── scheduler.js       # 定时任务调度模块
│   ├── monitor.js         # 监控模块
│   ├── daemon.js          # 守护进程模块
│   ├── server.js          # HTTP服务器模块
│   ├── httpServer.js      # HTTP服务器实现
├── images/                # 彩票图片生成目录
├── logs/                  # 日志文件目录
│   ├── app.log           # 应用日志
│   ├── error.log         # 错误日志
│   ├── schedule.log      # 调度日志
│   └── pm2-*.log         # PM2日志
├── output/                # 本地文章输出目录
│   └── 2025/              # 按年月分类的文章目录
│       └── 12/            # 具体月份的文章目录
├── history/               # 推送历史记录目录
├── scripts/               # 服务脚本目录
├── shuangseqiu/           # 双色球数据服务目录
├── test_draft_creation.js # 草稿创建功能测试
├── test_date_matching.js  # 日期匹配功能测试
├── .env.example           # 环境变量配置示例
├── .gitignore            # Git忽略文件
├── package.json          # 项目配置
├── ecosystem.config.js   # PM2配置文件
└── README.md            # 项目说明
```

## 日志管理

项目提供完整的日志记录功能：

### 日志文件

- `logs/app.log` - 应用运行日志
- `logs/error.log` - 错误日志
- `logs/schedule.log` - 定时任务日志
- `logs/pm2-*.log` - PM2进程管理日志

### 日志级别

- **info** - 一般信息
- **warn** - 警告信息
- **error** - 错误信息
- **debug** - 调试信息

### 查看日志

```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
tail -f logs/error.log

# 查看调度日志
tail -f logs/schedule.log

# 使用服务脚本查看日志
./scripts/service.sh logs
```

## 错误处理

程序包含完善的错误处理机制：

- **网络请求失败**: 自动重试和超时处理
- **API调用失败**: 详细的错误信息输出
- **配置缺失**: 友好的提示信息
- **文件操作失败**: 异常捕获和日志记录
- **进程异常**: 自动重启和状态监控

## 服务监控

### 健康检查

后台服务包含自动健康检查功能：
- 每小时检查一次服务状态
- 记录内存使用情况
- 监控任务执行状态

### 进程管理

使用PM2进行进程管理：
- 自动重启异常进程
- 内存使用监控
- 日志轮转管理
- 集群模式支持

### 状态查询

```bash
# 查看服务状态
npm run daemon:status

# 查看PM2状态
npm run pm2:status

# 使用服务脚本查看状态
./scripts/service.sh status
```

## 注意事项

1. **API限制**: 请注意各API的调用频率限制
2. **网络环境**: 确保服务器能够访问相关API接口
3. **权限配置**: 微信公众号需要相应的接口权限
4. **数据安全**: 请妥善保管API密钥和配置信息
5. **定时任务**: 确保系统时间准确，避免定时任务执行异常
6. **磁盘空间**: 定期清理日志文件，避免磁盘空间不足
7. **进程监控**: 建议使用PM2或systemd进行生产环境部署

## 鸣谢

感谢以下优秀的开源项目和服务，为本项目提供了重要支持：



### 🤖 AI服务
- **[智谱AI](https://open.bigmodel.cn/)**
  - 提供强大的AI文章生成能力
  - 智能内容创作和文本处理
  - 专业的大模型服务

感谢这些项目的开发者和维护者，让我们能够构建更好的自动化工具！

### 落地项目
https://mp.weixin.qq.com/s/Q6czcqKrWl_fNm4mdclb-w

## 许可证

MIT License

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 更新日志

### v1.2.0
- 🔄 AI服务切换：从元宝AI切换到智谱AI
- 🔧 更新AI服务配置，支持智谱AI标准聊天接口
- 🔧 优化AI响应解析，适配智谱AI返回格式
- 📝 更新配置文件，使用智谱AI环境变量
- 📄 更新README文档，移除元宝AI相关内容
- 🔧 修复AI服务调用逻辑，提高稳定性

### v1.1.0
- ✨ 新增彩票信息推送功能，支持双色球、快乐8、七乐彩、福彩3D
- ✨ 实现统一标题格式：【彩票类型】开奖结果第【开奖期号】期中奖号码
- ✨ 优化AI提示词，添加彩票类型信息，确保内容准确性
- ✨ 实现日期匹配功能，只推送当天开奖的彩票信息
- ✨ 固定文章顺序：双色球、快乐8、七乐彩、福彩3D
- ✨ 支持动态文章数量，根据当天开奖情况生成对应数量的文章
- ✨ 统一文章排版样式，确保四种彩票类型文章格式一致
- ✨ 新增彩票图片生成功能，为每篇文章生成对应彩票图片
- ✨ 添加测试脚本：test_draft_creation.js 和 test_date_matching.js
- ✨ 实现删除昨天上传素材的功能，保持素材库清洁
- ✨ 调整定时任务，添加彩票数据预加载任务
- ✨ 推送时间调整为每天9点，确保有充足的时间获取最新数据
- ✨ 实现服务自动启动机制，支持后台守护进程和PM2进程管理
- 🔧 修复marked模块使用方式，从marked()改为marked.parse()
- 🔧 修复文章解析时的undefined错误
- 🔧 优化标题处理逻辑，支持自动截断过长标题
- 🔧 简化项目结构，移除不必要的文件
- 🔧 移除60s新闻相关内容，专注于彩票信息推送
- 🔧 更新依赖，移除未使用的依赖
- 📝 完善README文档，添加详细的功能说明和使用指南
- 📊 优化日志记录，提高调试效率

### v1.0.0
- 初始版本发布
- 支持元宝AI文章生成
- 支持微信公众号推送
- 支持本地文件保存
